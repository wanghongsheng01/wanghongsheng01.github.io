var a=Object.defineProperty,e=Object.defineProperties,t=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,l=(e,t,s)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,c=(a,e)=>{for(var t in e||(e={}))r.call(e,t)&&l(a,t,e[t]);if(s)for(var t of s(e))o.call(e,t)&&l(a,t,e[t]);return a},n=(a,s)=>e(a,t(s)),i=(a,e,t)=>new Promise((s,r)=>{var o=a=>{try{c(t.next(a))}catch(e){r(e)}},l=a=>{try{c(t.throw(a))}catch(e){r(e)}},c=a=>a.done?s(a.value):Promise.resolve(a.value).then(o,l);c((t=t.apply(a,e)).next())});import{d as u,r as d,a1 as p,o as f,e as k,w as y,E as g,i as m,f as v,g as b,J as _,x as h,F as D,y as w,n as P,j as T,k as j,t as x,K as I,l as O,B as S,a2 as C,z as $}from"./index-BWcxsYn8.js";import{m as B}from"./mockApi.Dwynr1J8.js";import{C as E}from"./CustomTabBar.CiXty17D.js";import{N as z}from"./NavigationBar.BembfXLU.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";const N=L(u({__name:"index",setup(a){const e=d(!0),t=d([]),s=d({todayPoints:0,totalPoints:0,completedTasks:0,totalTasks:0,streak:0}),r=d(""),o=d("success"),l=d({lastCheckInDate:"",consecutiveDays:0}),u=a=>({learning:"🧠",training:"📈",system:"🎯",social:"👥"}[a]||"📝"),L=(a,e="success")=>{r.value=a,o.value=e,setTimeout(()=>{r.value=""},3e3)},N=()=>i(this,null,function*(){const a=(new Date).toDateString(),e=l.value.lastCheckInDate;if(e===a)return void L("今天已经打卡了！","error");const t=new Date;t.setDate(t.getDate()-1);let s=1;e===t.toDateString()&&(s=l.value.consecutiveDays+1),l.value.lastCheckInDate=a,l.value.consecutiveDays=s,J();try{const a=yield B.reportUserEvent({eventType:"daily_checkin",eventData:{},timestamp:(new Date).toISOString()});if(200===a.code){for(const e of a.data.affectedTasks)yield q(e.taskId,e.newProgress,!0);L(`打卡成功！连续打卡${s}天`,"success")}}catch(r){console.error("上报打卡事件失败:",r),L("打卡失败","error")}}),q=(a,e,r=!1)=>i(this,null,function*(){const o=t.value.findIndex(e=>e.id===a);if(-1!==o){const c=t.value[o];if(c.progress=Math.min(e,c.target),c.progress>=c.target&&"completed"!==c.status)try{if(200===(yield B.completeTask(a)).code){c.status="completed";const e=yield B.claimTaskReward(a);200===e.code&&(c.status="claimed",s.value.todayPoints=e.data.newTodayPoints,s.value.totalPoints=e.data.newTotalPoints,s.value.completedTasks+=1,r||L(`任务完成！+${e.data.reward.amount}积分`,"success"))}}catch(l){console.error("完成任务失败:",l),L("完成任务失败","error")}}}),A=()=>i(this,null,function*(){try{const a=yield B.getDailyTasks();200===a.code&&a.data&&(t.value=a.data)}catch(a){L("加载任务失败","error")}}),F=()=>i(this,null,function*(){try{const a=yield B.getTaskStats("1");200===a.code&&a.data&&(s.value=a.data)}catch(a){console.error("加载用户统计失败:",a)}}),J=()=>{try{$("taskLocalStats",l.value)}catch(a){console.error("保存本地统计失败:",a)}};return p(()=>{A(),F()}),f(()=>i(this,null,function*(){e.value=!0,(()=>{try{const a=g("taskLocalStats");a&&(l.value=c(c({},l.value),a))}catch(a){console.error("加载本地统计失败:",a)}})(),yield Promise.all([A(),F()]),e.value=!1})),(a,e)=>{const s=T,l=m,i=O;return v(),k(l,{class:"tasks-page"},{default:y(()=>[b(z,{title:"任务"}),b(l,{class:"page-content"},{default:y(()=>[b(l,{class:"tasks-list"},{default:y(()=>[(v(!0),h(D,null,w(t.value,a=>{return v(),k(l,{key:a.id,class:P(["task-item",(e=a.type,t=a.status,`${"learning"===e?"task-blue":"training"===e?"task-green":"system"===e?"task-purple":"task-orange"} ${"completed"===t?"task-completed":""}`)])},{default:y(()=>[b(l,{class:"task-icon"},{default:y(()=>[b(s,{class:"icon-text"},{default:y(()=>[j(x(u(a.type)),1)]),_:2},1024)]),_:2},1024),b(l,{class:"task-content"},{default:y(()=>[b(l,{class:"task-info"},{default:y(()=>[b(s,{class:"task-name"},{default:y(()=>[j(x(a.name),1)]),_:2},1024),b(s,{class:"task-description"},{default:y(()=>[j(x(a.description),1)]),_:2},1024),b(s,{class:"task-reward"},{default:y(()=>[j("奖励：+"+x(a.reward.amount)+"积分",1)]),_:2},1024)]),_:2},1024),"completed"!==a.status?(v(),k(l,{key:0,class:"task-progress"},{default:y(()=>[b(l,{class:"progress-bar"},{default:y(()=>[b(l,{class:"progress-fill",style:I({width:a.progress/a.target*100+"%"})},null,8,["style"])]),_:2},1024),b(s,{class:"progress-text"},{default:y(()=>[j(x(a.progress)+"/"+x(a.target),1)]),_:2},1024)]),_:2},1024)):_("",!0)]),_:2},1024),b(l,{class:"task-action"},{default:y(()=>["not_started"===a.status||"in_progress"===a.status?(v(),k(i,{key:0,class:"task-btn active",onClick:e=>(a=>{switch(a.type){case"learning":S({url:"/pages/quiz/index",success:()=>{try{const e=C();e&&e.globalData&&(e.globalData=n(c({},e.globalData),{fromTask:!0,taskId:a.id}))}catch(e){console.error("设置全局状态失败:",e)}},fail:a=>{console.error("跳转失败:",a),L("跳转失败，请重试","error")}});break;case"training":S({url:"/pages/training/index",success:()=>{try{const e=C();e&&e.globalData&&(e.globalData=n(c({},e.globalData),{fromTask:!0,taskId:a.id}))}catch(e){console.error("设置全局状态失败:",e)}},fail:a=>{console.error("跳转失败:",a),L("跳转失败，请重试","error")}});break;case"system":N();break;case"social":L("分享功能开发中...","error")}})(a)},{default:y(()=>[j(" 去完成 ")]),_:2},1032,["onClick"])):"completed"===a.status?(v(),k(i,{key:1,class:"task-btn completed",disabled:""},{default:y(()=>[j(" 已完成 ")]),_:1})):_("",!0)]),_:2},1024)]),_:2},1032,["class"]);var e,t}),128))]),_:1}),r.value?(v(),k(l,{key:0,class:P(["message-toast",o.value])},{default:y(()=>[j(x(r.value),1)]),_:1},8,["class"])):_("",!0),b(E)]),_:1})]),_:1})}}}),[["__scopeId","data-v-d1b39cbe"]]);export{N as default};
